<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="//d3js.org/d3.v6.js"></script>
<script>

  // Adapted from Shan Carter's https://observablehq.com/@observablehq/simple-d3

const width = screen.width,
      height = screen.height;

function getData() {
  let numItems = Math.ceil(Math.random() * 50);

  // https://www.d3indepth.com/force-layout/
  let data = d3
      .range(numItems)
      .map(function(d, i) {
        return {
          "bubble_id": i * 7 + 13, //  Simulate some random ids from DB
          "cx": Math.random()*width,
          "cy": Math.random()*height,
          "radius" : (screen.width / 120),
          "fill": d3.scaleOrdinal(d3.schemeTableau10),
          "category": i % 3,
          "tx": "texas",   // this proves we got data from this getData function
        }
      })
  return data;
}

const svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

const mouseClickedCircle = function(click_info,bubble_object) {
  console.log("circle_id");
  console.log(bubble_object.bubble_id);
  // call bubble_click API with bubble_id
  // on response, update radius of bubble
  // updateAll()
}
const mouseClickedBackground = function(click_info) {
  console.log("not circle");
  console.log(click_info);
  updateAll();
/*
  svg.append("circle")
    .datum({id: 66})   // trying to add to nodes.. via https://octoperf.com/blog/2018/04/17/d3-js-mouse-events-and-transitions-tutorial/#how-to-bind-data-using-d3datum
  .attr("id", d => 66)   // not working.  I want / need id to identify individual circles
    .attr("cx", d => click_info.clientX)
    .attr("cy", d => click_info.clientY)
    .attr("r", d => screen.width / 100)
    .attr("fill", d3.scaleOrdinal(d3.schemeTableau10))
    .on("click",mouseClickedCircle);
*/

}
const mouseClickedSVG = function(click_info) {
  console.log(click_info);
  if(click_info.target.matches("circle")) {
    console.log("ignoring click info because circles catch their own clicks");
//    return mouseClickedCircle(click_info);   // not sure why I am returning this but kinda think that is how JS likes to be
  }
  if(click_info.target.matches("svg")) {
    return mouseClickedBackground(click_info); // not sure why I am returning this but kinda think that is how JS likes to be
  }
  // because of the returns we don't get down here
}

const circleEnter = function(enter) {
  console.log("entering");
  return enter    // https://www.createwithdata.com/enter-exit-with-d3-join/
  .append("circle")
  .attr("cx", d => d.cx)
  .attr("cy", d => d.cy)
  .attr("fill", d => d.fill)
  .attr("r", d => d.radius)    // will be inflated in 3000 milliseconds down below
  .on("mouseover",function(){
    d3.select(this).attr("r", d => Math.random() * screen.width / 20 + 20)
  })
  .on("click",mouseClickedCircle)
  // These cause a merge error in the .data(nodes).join(circleEnter,circleUpdate,circleExit)
  // .transition()
  // .duration(3000)  // milliseconds
  // .attr('r', d => screen.width / 100)
  // .style('opacity', 1)
}

const circleUpdate = function(update) {
  return update    // https://www.createwithdata.com/enter-exit-with-d3-join/
  .attr('r', function(d) {
    // todo update actual data so radius stays changed
    d.radius = d.radius+5;
    return d.radius;
  })
  .style("opacity", 0.5)
}

const circleExit = function(exit) {
  return exit    // https://www.createwithdata.com/enter-exit-with-d3-join/
    .transition()
    .duration(300)
    .attr('r',1000)
    .style('opacity', 0)
    .on('end', function() {
      d3.select(this).remove();
    });
}

function updateAll() {
  let nodes = getData();
  console.log(nodes);
svg
    .selectAll("circle")
    .data(nodes, function(d) {   // this keyFunction ensures bubbles stay consistent
      return d.bubble_id;    // id should come from MySQL DB bubbles.bubble_id
    })
    .join(circleEnter,circleUpdate,circleExit)    // https://www.createwithdata.com/enter-exit-with-d3-join/
}

svg.on("click",mouseClickedSVG);

</script>
