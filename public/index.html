<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="//d3js.org/d3.v6.js"></script>
<script>

  // Adapted from Shan Carter's https://observablehq.com/@observablehq/simple-d3

const width = screen.width,
      height = screen.height;

///  this declaration just allows data to be accessed in getData()
let data;

// DATA WAS Asynchronous but now it is reading from DB
function getData() {
  const promisetToGetBubbles = d3.json("//ppcapi.robnugen.com/api/v1/get_bubbles/");
  promisetToGetBubbles.then(updateAll).catch(console.log.bind(console));  // h/t console bit https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html
}

const svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

const server_inflate = function(bubble_object) {
  console.log("THEN");
  console.log(bubble_object);
  // console.log("here is data:   (how do we find the specific bubble shown above this line?)");
  // console.log(data);
  const searchIndex = data.findIndex(bubble => bubble.bubble_id==bubble_object.bubble_id);
  data[searchIndex].radius = bubble_object.radius;
  updateAll(data)   // this is SERVER response, which happens once server replies
}

const mouseClickedCircle = function(click_info,bubble_object) {
  // call bubble_click API with bubble_id
  var bubble_click_promise = d3.json("//ppcapi.robnugen.com/api/v1/click_bubble",{
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "entry=" + JSON.stringify(bubble_object)
  });
  // on response, update radius of bubble
  bubble_click_promise.then(server_inflate).catch(console.log.bind(console));  // h/t console bit https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html
  console.log("clicked bubble on  dog");
  console.log(bubble_click_promise);
}

const mouseClickedBackground = function(click_info) {
  console.log("want to create circle");
  console.log(click_info);
}

const mouseClickedSVG = function(click_info) {
  if(click_info.target.matches("svg")) {
    return mouseClickedBackground(click_info); // not sure why I am returning this but kinda think that is how JS likes to be
  }
  // because of the returns we don't get down here
}

const circleEnter = function(enter) {
  console.log("entering");
  return enter    // https://www.createwithdata.com/enter-exit-with-d3-join/
    .append("circle")
    .attr("cx", d => d.cx)
    .attr("cy", d => d.cy)
    .attr("fill", d => d.fill)
    .attr("r", d => d.radius)    // will be inflated in 3000 milliseconds down below
    .on("click",mouseClickedCircle)
}

const circleUpdate = function(update) {
  return update    // https://www.createwithdata.com/enter-exit-with-d3-join/
}

const circleExit = function(exit) {
  return exit    // https://www.createwithdata.com/enter-exit-with-d3-join/
    .transition()
    .duration(300)
    .attr('r',1000)
    .style('opacity', 0)
    .on('end', function() {
      d3.select(this).remove();
    });
}


function updateAll(nodes) {
  console.log("we got into updateAll");
  console.log(nodes);
  console.log("we got those nodes in updateAll");

  data = nodes;    /// Slamming this in because it fixes bubble Click

  return svg
    .selectAll("circle")
    .data(nodes, function(d) {   // this keyFunction ensures bubbles stay consistent
      console.log("bubble ID " + d.bubble_id + " is");
      console.log(d);
      return d.bubble_id;    // id should come from MySQL DB bubbles.bubble_id
    })
    .join(circleEnter,circleUpdate,circleExit)    // https://www.createwithdata.com/enter-exit-with-d3-join/
    .transition() ///  this transition is basically for circleUpdate changes
    .duration(100)
    .attr('r', function(d) {
      console.log("update radius " + d.radius);
      return d.radius;
    })
}

svg.on("click",mouseClickedSVG);

getData();

</script>
