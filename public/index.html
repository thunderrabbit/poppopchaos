<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="//d3js.org/d3.v6.js"></script>
<script>

  // Adapted from Shan Carter's https://observablehq.com/@observablehq/simple-d3

const width = screen.width,  /// / 2.2,       // just less than half (to fit two svg side by side)
      height = screen.height;  /// / 2.2;     // just less than half

///  this declaration just allows data to be accessed in getDataRight()
let dataLEFT;
let dataRIGHT;

function newBubbleObject(d, i) {
  return {
    "bubble_id": i * 7 + 13, //  Simulate some random ids from DB
    "cx": Math.random()*width,             // spread bubbles across screen
    "cy": Math.random()*height,
    "radius" : (screen.width / 120),              // based on screen width to hopefully make it work on mobile
    "fill": d3.scaleOrdinal(d3.schemeTableau10),  // color not working
    "category": i % 3,
    "tx": "texas",   // this proves we got dataRIGHT from this getDataRight function
  }
}

// locally set bubbles new radius.
// will be overridden if the server says a different number
function inflate(bubble_object) {
  console.log("INFLATING locally  (optimally will match server inflation rate)");
  console.log(bubble_object);
  // plus 5 on the next line is a proof of hack which needs to be mitigated by the server checking the Database for bubble ID radius.
  return bubble_object.radius + 5 + Math.min(bubble_object.radius / 100, 0.7);
}

// DATA is from JS
function getDataLEFT() {
/* eventually hide this so get_bubbles_promise can set data */
  let numItems = Math.random() * 505;

  // https://www.d3indepth.com/force-layout/
  dataLEFT = d3     // randomly alter our global variable.  Should be altered via GET request
      .range(numItems)
      .map(newBubbleObject)
/* eventually hide this so get_bubbles_promise can set data  */
  return dataLEFT;
}

// DATA WAS Asynchronous but now it is reading from DB
function getDataRight() {
  const promisetToGetBubbles = d3.json("//ppcapi.robnugen.com/api/v1/get_bubbles/");
  promisetToGetBubbles.then(updateAllRight).catch(console.log.bind(console));  // h/t console bit https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html
}

const svgRIGHT = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

const svgLEFT = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

const bubbles_received = function(bubbles_json) {
    console.log("We got these bubbles from server");
    console.log(bubbles_json);
}

const server_inflateLEFT = function(bubble_object) {
  console.log("THEN");
  console.log(bubble_object);
  const searchIndex = dataLEFT.findIndex(bubble => bubble.bubble_id==bubble_object.bubble_id);
  dataLEFT[searchIndex].radius = bubble_object.radius;
  updateAllLEFT(dataLEFT)   // this is SERVER response, which happens once server replies
}

const server_inflateRIGHT = function(bubble_object) {
  console.log("THEN");
  console.log(bubble_object);
  const searchIndex = dataRIGHT.findIndex(bubble => bubble.bubble_id==bubble_object.bubble_id);
  dataRIGHT[searchIndex].radius = bubble_object.radius;
  updateAllRight(dataRIGHT)   // this is SERVER response, which happens once server replies
}

const mouseClickedCircleLEFT = function(click_info,bubble_object) {
  console.log("circle_id");
  console.log(bubble_object.bubble_id);
  // figure out what circle was clicked and inflate it locally
  const searchIndex = dataLEFT.findIndex(bubble => bubble.bubble_id==bubble_object.bubble_id);
  dataLEFT[searchIndex].radius = inflate(bubble_object);
  updateAllLEFT(dataLEFT)   // this is a local update which should be reverted if server disagrees

  // call bubble_click API with bubble_id
  var bubble_click_promise = d3.json("/api/v1/click_bubble",{
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "entry=" + JSON.stringify(bubble_object)
  });
  // on response, update radius of bubble
  bubble_click_promise.then(server_inflateLEFT).catch(err => { console.log(err) });
  console.log("clicked bubble on LEFT dog");
  console.log(bubble_click_promise);
}

const mouseClickedCircleRIGHT = function(click_info,bubble_object) {
/*
dataRIGHT has no value here, probably because this function is a constant
and is instantiated before dataRIGHT has a value

This section is supposed to inflate the bubble locally
so we do not have to wait for the server.

I am taking it out in hopes I can get the server part to work,
i.e. the code below this multi-line comment
  console.log("circle_id");
  console.log(bubble_object);
  // figure out what circle was clicked and inflate it locally
  bubble_object.radius = inflate(bubble_object);
  updateAllRight(dataRIGHT)   // this is a local update which should be reverted if server disagrees
*/

  // call bubble_click API with bubble_id
  var bubble_click_promise = d3.json("//ppcapi.robnugen.com/api/v1/click_bubble",{
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "entry=" + JSON.stringify(bubble_object)
  });
  // on response, update radius of bubble
  bubble_click_promise.then(server_inflateRIGHT).catch(console.log.bind(console));  // h/t console bit https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html
  console.log("clicked bubble on RIGHT dog");
  console.log(bubble_click_promise);
}

const mouseClickedBackgroundLeft = function(click_info) {
  console.log("not circle");
  console.log(click_info);
  updateAllLEFT();
}

const mouseClickedBackgroundRight = function(click_info) {
  console.log("not circle");
  console.log(click_info);
  getDataRight();
/*
  svgRIGHT.append("circle")
    .datum({id: 66})   // trying to add to nodes.. via https://octoperf.com/blog/2018/04/17/d3-js-mouse-events-and-transitions-tutorial/#how-to-bind-data-using-d3datum
  .attr("id", d => 66)   // not working.  I want / need id to identify individual circles
    .attr("cx", d => click_info.clientX)
    .attr("cy", d => click_info.clientY)
    .attr("r", d => screen.width / 100)
    .attr("fill", d3.scaleOrdinal(d3.schemeTableau10))
    .on("click",mouseClickedCircleRIGHT);
*/

}

const mouseClickedSVGLEFT = function(click_info) {
  console.log(click_info);
  if(click_info.target.matches("circle")) {
    console.log("ignoring click info because circles catch their own clicks");
//    return mouseClickedCircle(click_info);   // not sure why I am returning this but kinda think that is how JS likes to be
  }
  if(click_info.target.matches("svg")) {
    return mouseClickedBackgroundLeft(click_info); // not sure why I am returning this but kinda think that is how JS likes to be
  }
  // because of the returns we don't get down here
}
const mouseClickedSVGRight = function(click_info) {
  console.log(click_info);
  if(click_info.target.matches("circle")) {
    console.log("ignoring click info because circles catch their own clicks");
//    return mouseClickedCircleRIGHT(click_info);   // not sure why I am returning this but kinda think that is how JS likes to be
  }
  if(click_info.target.matches("svg")) {
    return mouseClickedBackgroundRight(click_info); // not sure why I am returning this but kinda think that is how JS likes to be
  }
  // because of the returns we don't get down here
}

const circleEnterLEFT = function(enter) {
  console.log("entering");
  return enter    // https://www.createwithdata.com/enter-exit-with-d3-join/
  .append("circle")
  .attr("cx", d => d.cx)
  .attr("cy", d => d.cy)
  .attr("fill", d => d.fill)
  .attr("r", d => d.radius)    // will be inflated in 3000 milliseconds down below
  .on("click",mouseClickedCircleLEFT)
}

const circleEnterRIGHT = function(enter) {
  console.log("entering");
  return enter    // https://www.createwithdata.com/enter-exit-with-d3-join/
  .append("circle")
  .attr("cx", d => d.cx)
  .attr("cy", d => d.cy)
  .attr("fill", d => d.fill)
  .attr("r", d => d.radius)    // will be inflated in 3000 milliseconds down below
  // .on("mouseover",function(){   // stop fucking with stuff while we almost have clicks working
  //   d3.select(this).attr("r", d => Math.random() * screen.width / 20 + 20)
  // })
  .on("click",mouseClickedCircleRIGHT)
  // These cause a merge error in the .data(nodes).join(circleEnterRIGHT,circleUpdate,circleExit)
  // .transition()
  // .duration(3000)  // milliseconds
  // .attr('r', d => screen.width / 100)
  // .style('opacity', 1)
}

const circleUpdate = function(update) {
  return update    // https://www.createwithdata.com/enter-exit-with-d3-join/
  // .each(function(d,i) {   // stop fucking with stuff while we almost have clicks working
  //   // todo update actual data
  //   d.radius = d.radius + Math.random() * 50;
  // })
}

const circleExit = function(exit) {
  return exit    // https://www.createwithdata.com/enter-exit-with-d3-join/
    .transition()
    .duration(300)
    .attr('r',1000)
    .style('opacity', 0)
    .on('end', function() {
      d3.select(this).remove();
    });
}


function updateAllLEFT(data) {
  let nodes;

  if(data === undefined) {  // only works because data is the parameter for this function https://masteringjs.io/tutorials/fundamentals/undefined-check
    nodes = getDataLEFT();      // eventually get data from server
  } else {
    nodes = data;             // update per our local best guess
  }
  console.log("we got into updateAll LEFT");
  console.log(nodes);
  console.log("we got those nodes in updateAll LEFT");
  svgLEFT
    .selectAll("circle")
    .data(nodes, function(d) {   // this keyFunction ensures bubbles stay consistent
      return d.bubble_id;    // id should come from MySQL DB bubbles.bubble_id
    })
    .join(circleEnterLEFT,circleUpdate,circleExit)    // https://www.createwithdata.com/enter-exit-with-d3-join/
    .transition() ///  this transition is basically for circleUpdate changes
    .duration(100)
    .attr('r', function(d) {
      return d.radius;
    })
}

function updateAllRight(nodes) {
  console.log("we got into updateAllRight");
  console.log(nodes);
  console.log("we got those nodes in updateAllRight");

  dataRIGHT = nodes;    /// Slamming this in because it fixes bubble Click

  return svgRIGHT
    .selectAll("circle")
    .data(nodes, function(d) {   // this keyFunction ensures bubbles stay consistent
      console.log("bubble ID is");
      console.log(d.bubble_id);
      return d.bubble_id;    // id should come from MySQL DB bubbles.bubble_id
    })
    .join(circleEnterRIGHT,circleUpdate,circleExit)    // https://www.createwithdataRIGHT.com/enter-exit-with-d3-join/
    .transition() ///  this transition is basically for circleUpdate changes
    .duration(100)
    .attr('r', function(d) {
      console.log("just want to see if we are getting here");
      console.log(d);
      return d.radius;
    })
}

svgLEFT.on("click",mouseClickedSVGLEFT);

svgRIGHT.on("click",mouseClickedSVGRight);

</script>
